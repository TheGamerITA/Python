<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Obiettivi</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2f;
      --panel2:#101f3a;
      --text:#e9eefc;
      --muted:#a9b6d6;
      --border:rgba(255,255,255,.12);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(130,170,255,.25), transparent 60%),
                  radial-gradient(900px 500px at 100% 0%, rgba(255,150,220,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:24px;
    }
    .app{
      width:min(980px, 100%);
      display:grid;
      gap:16px;
    }
    header{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:18px 18px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    header h1{
      margin:0;
      font-size:20px;
      letter-spacing:.2px;
    }
    header .hint{
      color:var(--muted);
      font-size:13px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:16px;
    }
    @media (min-width: 860px){
      .grid{ grid-template-columns: 360px 1fr; }
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }
    .card h2{
      margin:0 0 10px 0;
      font-size:14px;
      color:var(--muted);
      font-weight:600;
      letter-spacing:.6px;
      text-transform:uppercase;
    }

    label{ display:block; font-size:13px; color:var(--muted); margin:10px 0 6px; }
    input[type="text"], textarea, select{
      width:100%;
      background: rgba(15,26,47,.65);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
    }
    textarea{ min-height:92px; resize:vertical; }

    .row{ display:flex; gap:10px; align-items:center; }
    .row > *{ flex:1; }
    .row .tight{ flex:0 0 auto; }

    .btn{
      cursor:pointer;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-weight:600;
      transition: transform .05s ease, background .2s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ background: rgba(255,255,255,.10); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      border-color: rgba(120,170,255,.45);
      background: rgba(120,170,255,.18);
    }
    .btn.danger{
      border-color: rgba(255,120,120,.4);
      background: rgba(255,120,120,.14);
    }

    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .toolbar .left, .toolbar .right{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .pill{
      padding:6px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      color:var(--muted);
      font-size:12px;
      background: rgba(255,255,255,.04);
    }

    .list{
      display:grid;
      gap:12px;
      margin-top:12px;
    }
    .item{
      border:1px solid var(--border);
      border-radius:14px;
      background: rgba(16,31,58,.55);
      padding:12px;
      display:grid;
      gap:10px;
    }
    .item.prio{
      border-color: rgba(255, 210, 120, .55);
      box-shadow: 0 0 0 1px rgba(255,210,120,.12), var(--shadow);
      background: linear-gradient(180deg, rgba(255,210,120,.10), rgba(16,31,58,.55));
    }
    .topline{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .title{
      font-weight:800;
      letter-spacing:.2px;
      line-height:1.2;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .badge{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      background: rgba(255,255,255,.05);
    }
    .badge.done{
      border-color: rgba(130, 255, 170, .35);
      background: rgba(130, 255, 170, .10);
      color:#c9ffe0;
    }
    .badge.prio{
      border-color: rgba(255, 210, 120, .45);
      background: rgba(255, 210, 120, .12);
      color:#ffe7bf;
    }
    .desc{
      color: var(--muted);
      font-size:13px;
      white-space:pre-wrap;
    }
    .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .muted{ color:var(--muted); }

    .strike{
      text-decoration: line-through;
      opacity:.85;
    }

    .footerRow{
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      font-size:12px;
      color:var(--muted);
      margin-top:10px;
    }
    a{ color:inherit; }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>Obiettivi</h1>
        <div class="hint">Crea, modifica, evidenzia (priorità) e segna come completati. Tutto si salva sul tuo dispositivo.</div>
      </div>
      <div class="pill" id="statsPill">0 obiettivi</div>
    </header>

    <div class="grid">
      <!-- FORM -->
      <section class="card" aria-label="Crea o modifica obiettivo">
        <h2>Nuovo / Modifica</h2>

        <input type="hidden" id="editingId" value="" />

        <label for="title">Titolo</label>
        <input id="title" type="text" placeholder="Es: Studiare 30 min al giorno" maxlength="120" />

        <label for="desc">Descrizione</label>
        <textarea id="desc" placeholder="Note, dettagli, cosa serve fare..."></textarea>

        <div class="row">
          <div>
            <label for="priority">Priorità</label>
            <select id="priority">
              <option value="normal">Normale</option>
              <option value="high">Alta (in evidenza)</option>
            </select>
          </div>
          <div>
            <label for="status">Stato</label>
            <select id="status">
              <option value="active">Non terminato</option>
              <option value="done">Terminato</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button class="btn primary" id="saveBtn">Salva obiettivo</button>
          <button class="btn" id="resetBtn" type="button">Pulisci</button>
          <button class="btn danger" id="deleteBtn" type="button" style="display:none;">Elimina</button>
        </div>

        <div class="footerRow">
          <span>Tip: click su “Modifica” per cambiare un obiettivo.</span>
          <span id="storageInfo">LocalStorage: ok</span>
        </div>
      </section>

      <!-- LISTA -->
      <section class="card" aria-label="Lista obiettivi">
        <h2>Lista</h2>

        <div class="toolbar">
          <div class="left">
            <input id="search" type="text" placeholder="Cerca..." style="width:min(320px, 100%);" />
            <select id="filter" style="width:170px;">
              <option value="all">Tutti</option>
              <option value="active">Non terminati</option>
              <option value="done">Terminati</option>
              <option value="prio">Prioritari</option>
            </select>
            <select id="sort" style="width:170px;">
              <option value="created_desc">Più recenti</option>
              <option value="created_asc">Meno recenti</option>
              <option value="prio_first">Priorità prima</option>
              <option value="done_last">Terminati ultimi</option>
            </select>
          </div>
          <div class="right">
            <button class="btn" id="exportBtn" type="button">Esporta JSON</button>
            <button class="btn danger" id="clearAllBtn" type="button">Svuota tutto</button>
          </div>
        </div>

        <div class="list" id="list"></div>
        <div class="muted" id="empty" style="margin-top:12px; display:none;">
          Nessun obiettivo trovato.
        </div>
      </section>
    </div>
  </div>

<script>
(() => {
  const STORAGE_KEY = "obiettivi_v1";

  const els = {
    statsPill: document.getElementById("statsPill"),
    editingId: document.getElementById("editingId"),
    title: document.getElementById("title"),
    desc: document.getElementById("desc"),
    priority: document.getElementById("priority"),
    status: document.getElementById("status"),
    saveBtn: document.getElementById("saveBtn"),
    resetBtn: document.getElementById("resetBtn"),
    deleteBtn: document.getElementById("deleteBtn"),
    list: document.getElementById("list"),
    empty: document.getElementById("empty"),
    search: document.getElementById("search"),
    filter: document.getElementById("filter"),
    sort: document.getElementById("sort"),
    exportBtn: document.getElementById("exportBtn"),
    clearAllBtn: document.getElementById("clearAllBtn"),
    storageInfo: document.getElementById("storageInfo"),
  };

  function uid() {
    return "g_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
  }

  function safeParse(json, fallback) {
    try { return JSON.parse(json); } catch { return fallback; }
  }

  function load() {
    const raw = localStorage.getItem(STORAGE_KEY);
    const data = safeParse(raw, []);
    return Array.isArray(data) ? data : [];
  }

  function save(data) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  function nowISO() {
    return new Date().toISOString();
  }

  function fmtDate(iso) {
    try {
      const d = new Date(iso);
      return d.toLocaleString("it-IT", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    } catch {
      return iso;
    }
  }

  function getFormData() {
    return {
      id: els.editingId.value || null,
      title: els.title.value.trim(),
      desc: els.desc.value.trim(),
      priority: els.priority.value, // normal | high
      status: els.status.value,     // active | done
    };
  }

  function resetForm() {
    els.editingId.value = "";
    els.title.value = "";
    els.desc.value = "";
    els.priority.value = "normal";
    els.status.value = "active";
    els.deleteBtn.style.display = "none";
    els.saveBtn.textContent = "Salva obiettivo";
    els.title.focus();
  }

  function setEditing(item) {
    els.editingId.value = item.id;
    els.title.value = item.title;
    els.desc.value = item.desc || "";
    els.priority.value = item.priority || "normal";
    els.status.value = item.status || "active";
    els.deleteBtn.style.display = "inline-block";
    els.saveBtn.textContent = "Aggiorna";
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function updateStats(data) {
    const total = data.length;
    const done = data.filter(x => x.status === "done").length;
    const prio = data.filter(x => x.priority === "high").length;
    els.statsPill.textContent = `${total} obiettivi • ${done} terminati • ${prio} prioritari`;
  }

  function applyFilters(data) {
    const q = els.search.value.trim().toLowerCase();
    const filter = els.filter.value;
    let out = [...data];

    if (q) {
      out = out.filter(x =>
        (x.title || "").toLowerCase().includes(q) ||
        (x.desc || "").toLowerCase().includes(q)
      );
    }

    if (filter === "active") out = out.filter(x => x.status === "active");
    if (filter === "done") out = out.filter(x => x.status === "done");
    if (filter === "prio") out = out.filter(x => x.priority === "high");

    const sort = els.sort.value;
    if (sort === "created_desc") out.sort((a,b) => (b.createdAt||"").localeCompare(a.createdAt||""));
    if (sort === "created_asc") out.sort((a,b) => (a.createdAt||"").localeCompare(b.createdAt||""));
    if (sort === "prio_first") out.sort((a,b) => (b.priority==="high") - (a.priority==="high") || (b.createdAt||"").localeCompare(a.createdAt||""));
    if (sort === "done_last") out.sort((a,b) => (a.status==="done") - (b.status==="done") || (b.createdAt||"").localeCompare(a.createdAt||""));

    return out;
  }

  function render() {
    const data = load();
    updateStats(data);

    const view = applyFilters(data);
    els.list.innerHTML = "";

    els.empty.style.display = view.length ? "none" : "block";

    for (const item of view) {
      const isDone = item.status === "done";
      const isPrio = item.priority === "high";

      const wrap = document.createElement("div");
      wrap.className = "item" + (isPrio ? " prio" : "");

      const top = document.createElement("div");
      top.className = "topline";

      const left = document.createElement("div");

      const title = document.createElement("div");
      title.className = "title" + (isDone ? " strike" : "");
      title.textContent = item.title || "(Senza titolo)";

      const badges = document.createElement("div");
      badges.style.display = "flex";
      badges.style.gap = "6px";
      badges.style.marginTop = "6px";
      badges.style.flexWrap = "wrap";

      if (isPrio) {
        const b = document.createElement("span");
        b.className = "badge prio";
        b.textContent = "PRIORITÀ";
        badges.appendChild(b);
      }
      const b2 = document.createElement("span");
      b2.className = "badge" + (isDone ? " done" : "");
      b2.textContent = isDone ? "TERMINATO" : "NON TERMINATO";
      badges.appendChild(b2);

      const meta = document.createElement("div");
      meta.className = "muted";
      meta.style.fontSize = "12px";
      meta.style.marginTop = "6px";
      meta.textContent = "Creato: " + fmtDate(item.createdAt || nowISO());

      left.appendChild(title);
      left.appendChild(badges);
      left.appendChild(meta);

      const right = document.createElement("div");
      right.className = "actions";

      const toggleDoneBtn = document.createElement("button");
      toggleDoneBtn.className = "btn";
      toggleDoneBtn.textContent = isDone ? "Riapri" : "Termina";
      toggleDoneBtn.addEventListener("click", () => toggleDone(item.id));

      const togglePrioBtn = document.createElement("button");
      togglePrioBtn.className = "btn";
      togglePrioBtn.textContent = isPrio ? "Togli priorità" : "Metti priorità";
      togglePrioBtn.addEventListener("click", () => togglePriority(item.id));

      const editBtn = document.createElement("button");
      editBtn.className = "btn primary";
      editBtn.textContent = "Modifica";
      editBtn.addEventListener("click", () => setEditing(item));

      right.appendChild(toggleDoneBtn);
      right.appendChild(togglePrioBtn);
      right.appendChild(editBtn);

      top.appendChild(left);
      top.appendChild(right);

      wrap.appendChild(top);

      if (item.desc) {
        const desc = document.createElement("div");
        desc.className = "desc" + (isDone ? " strike" : "");
        desc.textContent = item.desc;
        wrap.appendChild(desc);
      }

      els.list.appendChild(wrap);
    }
  }

  function upsert(item) {
    const data = load();
    if (!item.title) {
      alert("Inserisci almeno un titolo.");
      return;
    }

    if (item.id) {
      const idx = data.findIndex(x => x.id === item.id);
      if (idx === -1) return;

      data[idx] = {
        ...data[idx],
        title: item.title,
        desc: item.desc,
        priority: item.priority,
        status: item.status,
        updatedAt: nowISO(),
      };
    } else {
      data.unshift({
        id: uid(),
        title: item.title,
        desc: item.desc,
        priority: item.priority,
        status: item.status,
        createdAt: nowISO(),
        updatedAt: nowISO(),
      });
    }

    save(data);
    resetForm();
    render();
  }

  function remove(id) {
    const data = load().filter(x => x.id !== id);
    save(data);
    resetForm();
    render();
  }

  function toggleDone(id) {
    const data = load();
    const x = data.find(i => i.id === id);
    if (!x) return;
    x.status = x.status === "done" ? "active" : "done";
    x.updatedAt = nowISO();
    save(data);
    render();
  }

  function togglePriority(id) {
    const data = load();
    const x = data.find(i => i.id === id);
    if (!x) return;
    x.priority = x.priority === "high" ? "normal" : "high";
    x.updatedAt = nowISO();
    save(data);
    render();
  }

  function exportJSON() {
    const data = load();
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "obiettivi.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(a.href), 500);
  }

  function clearAll() {
    const ok = confirm("Vuoi davvero eliminare TUTTI gli obiettivi? (Non si può annullare)");
    if (!ok) return;
    save([]);
    resetForm();
    render();
  }

  // Events
  els.saveBtn.addEventListener("click", () => upsert(getFormData()));
  els.resetBtn.addEventListener("click", resetForm);

  els.deleteBtn.addEventListener("click", () => {
    const id = els.editingId.value;
    if (!id) return;
    const ok = confirm("Eliminare questo obiettivo?");
    if (!ok) return;
    remove(id);
  });

  els.search.addEventListener("input", render);
  els.filter.addEventListener("change", render);
  els.sort.addEventListener("change", render);

  els.exportBtn.addEventListener("click", exportJSON);
  els.clearAllBtn.addEventListener("click", clearAll);

  // Storage check
  try {
    localStorage.setItem("__test__", "1");
    localStorage.removeItem("__test__");
    els.storageInfo.textContent = "LocalStorage: ok";
  } catch {
    els.storageInfo.textContent = "LocalStorage: NON disponibile";
  }

  // Init
  resetForm();
  render();
})();
</script>
</body>
</html>
